<!--
Simple COVID-19 charting code, single-page HTML javascript.
-->
<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js" integrity="sha256-iAuxnf8Cwr0yrQkpf6oQG4PaL/oVmoer6V/RfX2KQws=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.js" integrity="sha256-Nyn8cCQAr3TDltwQENC7vbHQaLKy9xuq8xon2BNZgPk=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.css" integrity="sha256-seGyqLj5T52Hx8W7/YTajtNXGXQf+IksfkcaKGoTkbY=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js" integrity="sha256-ngFW3UnAN0Tnm76mDuu7uUtYEcG3G5H1+zioJw3t+68=" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
<script>// Tooltip plugin needs these lowercased globals, oddly enough.
chartist = Chartist; jquery = $;
</script>
<script src="https://cdn.jsdelivr.net/npm/chartist-plugin-tooltip@0.0.11/chartist-plugin-tooltip.js" integrity="sha256-ngO2WQ2lK5livpEUubW2qbfre03s8rHixhMguuXbaAs=" crossorigin="anonymous"></script>
<script src="lib/chartist-plugin-legend.js"></script>
<script src="lib/chartist-logaxis.js"></script>
<script src="lib/chartist-print.js"></script>
<script src="lib/usa_states.js"></script>
<link rel="stylesheet" href="lib/select.css">
<link rel="stylesheet" href="lib/chart.css">
<style>
body { background: #FFF1E3; color: #333;
  font-family: 'Open Sans', sans-serif; font-size: 10pt; }
h1 { font-size: 14pt; }
@media only screen and (max-width:799px) {
  .ct-line { stroke-width: 2px; }
  .ct-point { stroke-width: 5px; }
}
@media only screen and (min-width:800px) {
  .pane-menu { display: inline-block; width: 26%; }
  .pane-chart { display: inline-block; width: 73%; float: right; }
  .ct-line { stroke-width: 3px; }
  .ct-point { stroke-width: 8px; }
}
@media only print {
  .pane-chart { width: 100% }
  body { background: none; }
}
</style>
</head>
<body>
<div id="app" class="pane-menu">
<h1>USA COVID-19 Time Series</h1>
<p>Whole-country stats along with the top 10 states are shown;
data are pulled directly from
<a href="https://github.com/CSSEGISandData/COVID-19/" >Johns Hopkins CSSE</a>.
<p>
<select v-model="chosen_series" class="select-css">
  <option v-for="option in series_choices" v-bind:value="option">
    {{ option }}
  </option>
</select>
<select v-model="chosen_stat" class="select-css">
  <option v-for="option in stat_choices" v-bind:value="option">
    {{ option }}
  </option>
</select>
<select v-model="chosen_scale" class="select-css">
  <option v-for="option in chosen_stat == 'deltas' ? ['linear'] : scale_choices" v-bind:value="option">
    {{ option }}
  </option>
</select>
<p>Click on the legend to toggle a series;
hover on points for specific numbers.</p>
</div
><div id="chart" class="pane-chart ct-chart ct-perfect-fourth"></div
><div class="pane-credit">
<p>My physician wife wanted to see some summaries of U.S. covid-19
stats that are not graphed in the press, so I wrote this short HTML
page to create those rollups.

<p>This page is about 200 lines of HTML+JS, using chartist.js
(with legend, tooltip, and logaxis extensions), vue.js, lodash.js, and
papaparse.
It should be easy to generalize to international data or other stats,
and pull requests are welcome.

<p>Code is at <a href="https://github.com/davidbau/covid-19-chart"
>https://github.com/davidbau/covid-19-chart</a>.

<p>Open source. (MIT license.)
<p>- David Bau
</div
></body>
<script>
var csse = null, chart = null;
function csv_url(seriesname) {
  var ts_base_url = "https://raw.githubusercontent.com/CSSEGISandData" +
    "/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/";
  return ts_base_url + "time_series_19-covid-" + seriesname + ".csv";
}
function load_csse_data(loaded) {
  var results = {}, pending = 3;
  'Confirmed Deaths Recovered'.split(' ').map(s => {
    Papa.parse(csv_url(s), {
      download: true,
      complete: r => {
        results[s.toLowerCase()] = r.data;
        pending -= 1;
        if (!pending) loaded(results);
      }
    })
  })
}
function parse_date(name) {
  return /^(\d{1,2})\/(\d{1,2})\/(\d{2})$/.exec(name);
}
function fieldnum(names, pat) {
  return names.findIndex(n => RegExp(pat, 'i').exec(n))
}
function first_date_field(names) {
  return names.findIndex(n => !!parse_date(n));
}
function rollup_ts(series, state_filter, country_filter) {
  var names = series[0],
    state_i = fieldnum(names, 'state'),
    country_i = fieldnum(names, 'country'),
    ts_i = first_date_field(names),
    ts_names = names.slice(ts_i),
    totals = _.fill(Array(ts_names.length), 0);
  for (var row of series.slice(1)) {
    if (state_filter && !state_filter(row[state_i]) ||
        country_filter &&  !country_filter(row[country_i])) {
      continue;
    }
    for (var i = ts_i; i < names.length; ++i) {
      totals[i - ts_i] += parseInt(row[i]);
    }
  }
  return [ts_names, totals];
}
function series_deltas(series) {
  var deltas = _.fill(Array(series.length), 0);
  deltas[0] = series[0];
  for (var i = 1; i < series.length; ++i) {
    deltas[i] = series[i] - series[i - 1];
  }
  return deltas;
}
function get_state_data(field, chosen_abbrev, chosen_full) {
  var dates, totals, deltas;
  [dates, totals] = rollup_ts(csse[field],
    state => { return !chosen_abbrev ||
       state.endsWith(chosen_abbrev) ||
       state == chosen_full },
    country => { return /^US$/.exec(country) });
  deltas = series_deltas(totals);
  return { dates: dates, totals: totals, deltas: deltas }
}
function plot_data(field, stat, scale) {
  field = field || 'confirmed';
  stat = stat || 'totals';
  scale = scale || 'log10';
  var national_data = get_state_data(field, null);
  var first_nz = _.findIndex(national_data.totals, i => i > 0);
  var national_series = national_data[stat].slice(first_nz);
  var dates = national_data.dates.slice(first_nz);
  var state_series = _.transform(USA_STATES, (r, v, k) => {
    r[k] = get_state_data(field, k, v)[stat].slice(first_nz);
    if (/log/.exec(scale)) {
      r[k] = r[k].map(x => x > 0 ? x : null)
    }
  });
  var top_states = _.toPairs(state_series)
      .sort((x, y) => (_.last(y[1]) || 0) - (_.last(x[1]) || 0)).slice(0, 10);
  if (chart) { chart.detach(); }
  chart = new Chartist.Line('#chart', {
    labels: dates.map(x => x.replace(/(\d+)\/(\d+)\/20$/, '$1/\n$2')),
    series: _.concat([national_series], top_states.map(x => x[1])),
  }, {
    classNames: {
      gridMinor: 'ct-grid-minor'
    },
    axisX: {
      labelInterpolationFnc: function skipLabels(value, index) {
        return index % 7  === (dates.length - 1) % 7 ? value : null;
      },
    },
    axisY: {
      showMinorGrid: true,
      type: Chartist.AutoScaleAxis,
      scale: scale,
    },
    chartPadding: {
      top: 50,
      bottom: 10,
      left: 20,
      right: 10,
    },
    plugins: [
      Chartist.plugins.legend({
        legendNames: _.concat(['US'], top_states.map(x => x[0]))
      }),
      Chartist.plugins.tooltip()
    ]
  });
  preparePrintChart(chart);
  return chart;
}
var theapp = new Vue({
  el: '#app',
  data: {
    series_choices: ['confirmed', 'deaths'], // 'recovered' seems incomplete.
    stat_choices: ['totals', 'deltas'],
    scale_choices: ['linear', 'log10'],
    chosen_series: 'confirmed',
    chosen_stat: 'totals',
    chosen_scale: 'log10'
  },
  watch: {
    chosen_series: function(val) { this.draw_chart(); },
    chosen_stat: function(val) {
      if (val == 'deltas' && this.chosen_scale == 'log10') {
        this.chosen_scale = 'linear';
      }
      this.draw_chart();
    },
    chosen_scale: function(val) { this.draw_chart(); }
  },
  methods: {
    draw_chart: function() {
      plot_data(this.chosen_series, this.chosen_stat, this.chosen_scale);
    }
  }
});
load_csse_data((d) => {csse = d; plot_data()});

</script>
