<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js" integrity="sha256-iAuxnf8Cwr0yrQkpf6oQG4PaL/oVmoer6V/RfX2KQws=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script src="/lib/load_csse.js"></script>
<script src="/lib/load_flat_cds.js"></script>
<script src="/lib/utils.js"></script>
<script src="/lib/flatten_csse.js"></script>
<script src="/lib/usa_state_list.js"></script>
<script src="/lib/locations.js"></script>
</head>
<body>
<pre>
</pre>
<script>
var merged = null;

function merge_day(d1, d2) {
  var result = _.defaults({}, d1, d2);
  for (var field of ['confirmed', 'deaths', 'recovered', 'active', 'tested']) {
    if (d1[field] && d2[field]) {
      result[field] = Math.max(d1[field], d2[field]);
    }
  }
  return result;
}

var saved_a1, saved_a2;
function merge_locality(a1, a2) {
  a1 = a1.filter(d => !!d && d.daynum);
  a2 = a2.filter(d => !!d && d.daynum);
  saved_a1 = a1;
  saved_a2 = a2;
  var result = [], i1 = 0, i2 = 0;
  while (i1 < a1.length || i2 < a2.length) {
    if (i1 < a1.length && (i2 >= a2.length || a1[i1].daynum < a2[i2].daynum)) {
      result.push(a1[i1]);
      i1 += 1;
    } else if (i1 >= a1.length || a2[i2].daynum < a1[i1].daynum) {
      result.push(a2[i2]);
      i2 += 1;
    } else {
      result.push(merge_day(a1[i1], a2[i2]));
      i1 += 1;
      i2 += 1;
    }
  }
  return result;
}

function merge_feeds(s1, s2) {
  var result = _.defaults({}, s1, s2);
  result = _.mapValues(result, (v, k) => {
    if (s1[k] && s2[k]) {
      return merge_locality(s1[k], s2[k]);
    }
    return v;
  });
  return result;
}

var cds, csse;
Promise.all([
  flatten_promise(load_csse_data()).catch(e => {}),
  load_flat_cds_data().catch(e => {}),
]).then(x => {
  [csse, cds] = x;
  merged = merge_feeds(csse || {}, cds || {});
  document.querySelector('pre').innerText +=
    'Loaded csse with ' + _.size(csse) + ' localities\n' +
    'and cds with ' + _.size(cds) +' localities\n' +
    'and merged with ' + _.size(merged) +' localities';
});
</script>

